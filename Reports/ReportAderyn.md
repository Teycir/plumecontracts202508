# Aderyn Analysis Report

This report was generated by [Aderyn](https://github.com/Cyfrin/aderyn), a static analysis tool built by [Cyfrin](https://cyfrin.io), a blockchain security company. This report is not a substitute for manual audit or security review. It should not be relied upon for any purpose other than to assist in the identification of potential security vulnerabilities.
# Table of Contents

- [Aderyn Analysis Report](#aderyn-analysis-report)
- [Table of Contents](#table-of-contents)
- [Summary](#summary)
	- [Files Summary](#files-summary)
	- [Files Details](#files-details)
	- [Issue Summary](#issue-summary)
- [High Issues](#high-issues)
	- [H-1: `abi.encodePacked()` Hash Collision](#h-1-abiencodepacked-hash-collision)
	- [H-2: Unsafe Casting of integers](#h-2-unsafe-casting-of-integers)
	- [H-3: Contract Name Reused in Different Files](#h-3-contract-name-reused-in-different-files)
	- [H-4: Yul block contains `return`](#h-4-yul-block-contains-return)
	- [H-5: ETH transferred without address checks](#h-5-eth-transferred-without-address-checks)
	- [H-6: Weak Randomness](#h-6-weak-randomness)
	- [H-7: Contract locks Ether without a withdraw function](#h-7-contract-locks-ether-without-a-withdraw-function)
	- [H-8: Reentrancy: State change after external call](#h-8-reentrancy-state-change-after-external-call)

# Summary

## Files Summary

| Key | Value |
| --- | --- |
| .sol Files | 299 |
| Total nSLOC | 12367 |


## Files Details

| Filepath | nSLOC |
| --- | --- |
| src/Plume.sol | 68 |
| src/PlumeStaking.sol | 44 |
| src/PlumeStakingRewardTreasury.sol | 127 |
| src/facets/AccessControlFacet.sol | 49 |
| src/facets/ManagementFacet.sol | 412 |
| src/facets/RewardsFacet.sol | 509 |
| src/facets/StakingFacet.sol | 649 |
| src/facets/ValidatorFacet.sol | 659 |
| src/helpers/ArbSys.sol | 7 |
| src/interfaces/IAccessControl.sol | 11 |
| src/interfaces/IDateTime.sol | 47 |
| src/interfaces/IDeploy.sol | 6 |
| src/interfaces/IDeployer.sol | 17 |
| src/interfaces/IPlumeStaking.sol | 68 |
| src/interfaces/IPlumeStakingRewardTreasury.sol | 8 |
| src/interfaces/ISupraRouterContract.sol | 22 |
| src/lib/PlumeErrors.sol | 82 |
| src/lib/PlumeEvents.sol | 109 |
| src/lib/PlumeRewardLogic.sol | 539 |
| src/lib/PlumeRoles.sol | 8 |
| src/lib/PlumeStakingStorage.sol | 106 |
| src/lib/PlumeValidatorLogic.sol | 84 |
| **Total** | **12367** |


## Issue Summary

| Category | No. of Issues |
| --- | --- |
| High | 8 |


# High Issues

## H-1: `abi.encodePacked()` Hash Collision

abi.encodePacked() should not be used with dynamic types when passing the result to a hash function such as `keccak256()`. Use `abi.encode()` instead which will pad items to 32 bytes, preventing hash collisions: https://docs.soliditylang.org/en/v0.8.13/abi-spec.html#non-standard-packed-mode. (e.g. `abi.encodePacked(0x123,0x456)` => `0x123456` => `abi.encodePacked(0x1,0x23456)`, but `abi.encode(0x123,0x456)` => `0x0...1230...456`). Unless there is a compelling reason, `abi.encode` should be preferred. If there is only one argument to `abi.encodePacked()` it can often be cast to `bytes()` or `bytes32()` instead: https://ethereum.stackexchange.com/questions/30912/how-to-compare-strings-in-solidity#answer-82739. If all arguments are strings and or bytes, `bytes.concat()` should be used instead.

<details><summary>6 Found Instances</summary>


- Found in src/lib/vendor/solidstate-solidity/contracts/access/access_control/AccessControlInternal.sol [Line: 56](../plume/src/lib/vendor/solidstate-solidity/contracts/access/access_control/AccessControlInternal.sol#L56)

	```solidity
	                    abi.encodePacked(
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/factory/MinimalProxyFactory.sol [Line: 68](../plume/src/lib/vendor/solidstate-solidity/contracts/factory/MinimalProxyFactory.sol#L68)

	```solidity
	            abi.encodePacked(
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/token/ERC1155/metadata/ERC1155Metadata.sol [Line: 29](../plume/src/lib/vendor/solidstate-solidity/contracts/token/ERC1155/metadata/ERC1155Metadata.sol#L29)

	```solidity
	            return string(abi.encodePacked(baseURI, tokenIdURI));
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/token/ERC1155/metadata/ERC1155Metadata.sol [Line: 31](../plume/src/lib/vendor/solidstate-solidity/contracts/token/ERC1155/metadata/ERC1155Metadata.sol#L31)

	```solidity
	            return string(abi.encodePacked(baseURI, tokenId.toDecString()));
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/token/ERC721/metadata/ERC721MetadataInternal.sol [Line: 53](../plume/src/lib/vendor/solidstate-solidity/contracts/token/ERC721/metadata/ERC721MetadataInternal.sol#L53)

	```solidity
	            return string(abi.encodePacked(baseURI, tokenIdURI));
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/token/ERC721/metadata/ERC721MetadataInternal.sol [Line: 55](../plume/src/lib/vendor/solidstate-solidity/contracts/token/ERC721/metadata/ERC721MetadataInternal.sol#L55)

	```solidity
	            return string(abi.encodePacked(baseURI, tokenId.toDecString()));
	```

</details>



## H-2: Unsafe Casting of integers

Downcasting int/uints in Solidity can be unsafe due to the potential for data loss and unintended behavior.When downcasting a larger integer type to a smaller one (e.g., uint256 to uint128), the value may exceed the range of the target type,leading to truncation and loss of significant digits. Use OpenZeppelin's SafeCast library to safely downcast integers.

<details><summary>1 Found Instances</summary>


- Found in src/spin/DateTime.sol [Line: 263](../plume/src/spin/DateTime.sol#L263)

	```solidity
	        return uint8(weekNumber);
	```

</details>



## H-3: Contract Name Reused in Different Files

When compiling contracts with certain development frameworks (for example: Truffle), having contracts with the same name across different files can lead to one being overwritten.

<details><summary>12 Found Instances</summary>


- Found in src/interfaces/IAccessControl.sol [Line: 8](../plume/src/interfaces/IAccessControl.sol#L8)

	```solidity
	interface IAccessControl {
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/access/access_control/IAccessControl.sol [Line: 10](../plume/src/lib/vendor/solidstate-solidity/contracts/access/access_control/IAccessControl.sol#L10)

	```solidity
	interface IAccessControl is IAccessControlInternal {
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/cryptography/ECDSA.sol [Line: 9](../plume/src/lib/vendor/solidstate-solidity/contracts/cryptography/ECDSA.sol#L9)

	```solidity
	library ECDSA {
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/interfaces/IERC165.sol [Line: 11](../plume/src/lib/vendor/solidstate-solidity/contracts/interfaces/IERC165.sol#L11)

	```solidity
	interface IERC165 is IERC165Internal {
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/interfaces/IERC20.sol [Line: 11](../plume/src/lib/vendor/solidstate-solidity/contracts/interfaces/IERC20.sol#L11)

	```solidity
	interface IERC20 is IERC20Internal {
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/proxy/Proxy.sol [Line: 11](../plume/src/lib/vendor/solidstate-solidity/contracts/proxy/Proxy.sol#L11)

	```solidity
	abstract contract Proxy is IProxy {
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/security/initializable/Initializable.sol [Line: 8](../plume/src/lib/vendor/solidstate-solidity/contracts/security/initializable/Initializable.sol#L8)

	```solidity
	abstract contract Initializable is IInitializable, InitializableInternal {}
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/token/ERC20/metadata/IERC20Metadata.sol [Line: 10](../plume/src/lib/vendor/solidstate-solidity/contracts/token/ERC20/metadata/IERC20Metadata.sol#L10)

	```solidity
	interface IERC20Metadata is IERC20MetadataInternal {
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/token/ERC20/permit/IERC20Permit.sol [Line: 11](../plume/src/lib/vendor/solidstate-solidity/contracts/token/ERC20/permit/IERC20Permit.sol#L11)

	```solidity
	interface IERC20Permit is IERC20PermitInternal, IERC2612 {}
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/utils/Math.sol [Line: 5](../plume/src/lib/vendor/solidstate-solidity/contracts/utils/Math.sol#L5)

	```solidity
	library Math {
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/utils/SafeCast.sol [Line: 9](../plume/src/lib/vendor/solidstate-solidity/contracts/utils/SafeCast.sol#L9)

	```solidity
	library SafeCast {
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/utils/SafeERC20.sol [Line: 12](../plume/src/lib/vendor/solidstate-solidity/contracts/utils/SafeERC20.sol#L12)

	```solidity
	library SafeERC20 {
	```

</details>



## H-4: Yul block contains `return`

This causes the transaction execution to halt, and nothing after that call will execute including code following the assembly block.

<details><summary>1 Found Instances</summary>


- Found in src/lib/vendor/solidstate-solidity/contracts/proxy/Proxy.sol [Line: 42](../plume/src/lib/vendor/solidstate-solidity/contracts/proxy/Proxy.sol#L42)

	```solidity
	                return(0, returndatasize())
	```

</details>



## H-5: ETH transferred without address checks

Consider introducing checks for `msg.sender` to ensure the recipient of the money is as intended.

<details><summary>6 Found Instances</summary>


- Found in src/lib/vendor/solidstate-solidity/contracts/token/ERC721/base/ERC721BaseMock.sol [Line: 55](../plume/src/lib/vendor/solidstate-solidity/contracts/token/ERC721/base/ERC721BaseMock.sol#L55)

	```solidity
	    function checkOnERC721Received(
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/utils/AddressUtilsMock.sol [Line: 19](../plume/src/lib/vendor/solidstate-solidity/contracts/utils/AddressUtilsMock.sol#L19)

	```solidity
	    function sendValue(address payable account, uint256 amount) external {
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/utils/AddressUtilsMock.sol [Line: 23](../plume/src/lib/vendor/solidstate-solidity/contracts/utils/AddressUtilsMock.sol#L23)

	```solidity
	    function functionCall(
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/utils/AddressUtilsMock.sol [Line: 30](../plume/src/lib/vendor/solidstate-solidity/contracts/utils/AddressUtilsMock.sol#L30)

	```solidity
	    function functionCall(
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/utils/AddressUtilsMock.sol [Line: 38](../plume/src/lib/vendor/solidstate-solidity/contracts/utils/AddressUtilsMock.sol#L38)

	```solidity
	    function functionCallWithValue(
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/utils/AddressUtilsMock.sol [Line: 46](../plume/src/lib/vendor/solidstate-solidity/contracts/utils/AddressUtilsMock.sol#L46)

	```solidity
	    function functionCallWithValue(
	```

</details>



## H-6: Weak Randomness

The use of keccak256 hash functions on predictable values like block.timestamp, block.number, or similar data, including modulo operations on these values, should be avoided for generating randomness, as they are easily predictable and manipulable. The `PREVRANDAO` opcode also should not be used as a source of randomness. Instead, utilize Chainlink VRF for cryptographically secure and provably random values to ensure protocol integrity.

<details><summary>2 Found Instances</summary>


- Found in src/spin/Raffle.sol [Line: 229](../plume/src/spin/Raffle.sol#L229)

	```solidity
	            uint256(keccak256(abi.encodePacked(prizeId, block.timestamp))),
	```

- Found in src/spin/Spin.sol [Line: 188](../plume/src/spin/Spin.sol#L188)

	```solidity
	        uint256 clientSeed = uint256(keccak256(abi.encodePacked(admin, block.timestamp)));
	```

</details>



## H-7: Contract locks Ether without a withdraw function

It appears that the contract includes a payable function to accept Ether but lacks a corresponding function to withdraw it, which leads to the Ether being locked in the contract. To resolve this issue, please implement a public or external function that allows for the withdrawal of Ether from the contract.

<details><summary>19 Found Instances</summary>


- Found in src/Plume.sol [Line: 20](../plume/src/Plume.sol#L20)

	```solidity
	contract Plume is
	```

- Found in src/PlumeStaking.sol [Line: 44](../plume/src/PlumeStaking.sol#L44)

	```solidity
	contract PlumeStaking is SolidStateDiamond {
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/proxy/ProxyMock.sol [Line: 7](../plume/src/lib/vendor/solidstate-solidity/contracts/proxy/ProxyMock.sol#L7)

	```solidity
	contract ProxyMock is Proxy {
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/proxy/diamond/SolidStateDiamondMock.sol [Line: 7](../plume/src/lib/vendor/solidstate-solidity/contracts/proxy/diamond/SolidStateDiamondMock.sol#L7)

	```solidity
	contract SolidStateDiamondMock is SolidStateDiamond {}
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/proxy/diamond/base/DiamondBaseMock.sol [Line: 8](../plume/src/lib/vendor/solidstate-solidity/contracts/proxy/diamond/base/DiamondBaseMock.sol#L8)

	```solidity
	contract DiamondBaseMock is DiamondBase, DiamondWritableInternal {
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/proxy/diamond/fallback/DiamondFallbackMock.sol [Line: 8](../plume/src/lib/vendor/solidstate-solidity/contracts/proxy/diamond/fallback/DiamondFallbackMock.sol#L8)

	```solidity
	contract DiamondFallbackMock is DiamondFallback, DiamondWritableInternal {
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/proxy/diamond/readable/DiamondReadableMock.sol [Line: 12](../plume/src/lib/vendor/solidstate-solidity/contracts/proxy/diamond/readable/DiamondReadableMock.sol#L12)

	```solidity
	contract DiamondReadableMock is
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/proxy/diamond/writable/DiamondWritableMock.sol [Line: 11](../plume/src/lib/vendor/solidstate-solidity/contracts/proxy/diamond/writable/DiamondWritableMock.sol#L11)

	```solidity
	contract DiamondWritableMock is DiamondBase, DiamondWritable, ERC165Base {
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/proxy/managed/ManagedProxyMock.sol [Line: 7](../plume/src/lib/vendor/solidstate-solidity/contracts/proxy/managed/ManagedProxyMock.sol#L7)

	```solidity
	contract ManagedProxyMock is ManagedProxy {
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/proxy/managed/ManagedProxyOwnableMock.sol [Line: 7](../plume/src/lib/vendor/solidstate-solidity/contracts/proxy/managed/ManagedProxyOwnableMock.sol#L7)

	```solidity
	contract ManagedProxyOwnableMock is ManagedProxyOwnable {
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/proxy/upgradeable/UpgradeableProxyMock.sol [Line: 7](../plume/src/lib/vendor/solidstate-solidity/contracts/proxy/upgradeable/UpgradeableProxyMock.sol#L7)

	```solidity
	contract UpgradeableProxyMock is UpgradeableProxy {
	```

- Found in src/lib/vendor/solidstate-solidity/contracts/proxy/upgradeable/UpgradeableProxyOwnableMock.sol [Line: 7](../plume/src/lib/vendor/solidstate-solidity/contracts/proxy/upgradeable/UpgradeableProxyOwnableMock.sol#L7)

	```solidity
	contract UpgradeableProxyOwnableMock is UpgradeableProxyOwnable {
	```

- Found in src/proxy/MockPUSDProxy.sol [Line: 10](../plume/src/proxy/MockPUSDProxy.sol#L10)

	```solidity
	contract MockPUSDProxy is ERC1967Proxy {
	```

- Found in src/proxy/PlumeProxy.sol [Line: 11](../plume/src/proxy/PlumeProxy.sol#L11)

	```solidity
	contract PlumeProxy is ERC1967Proxy {
	```

- Found in src/proxy/PlumeStakingProxy.sol [Line: 11](../plume/src/proxy/PlumeStakingProxy.sol#L11)

	```solidity
	contract PlumeStakingProxy is ERC1967Proxy {
	```

- Found in src/proxy/PlumeStakingRewardTreasuryProxy.sol [Line: 11](../plume/src/proxy/PlumeStakingRewardTreasuryProxy.sol#L11)

	```solidity
	contract PlumeStakingRewardTreasuryProxy is ERC1967Proxy {
	```

- Found in src/proxy/RaffleProxy.sol [Line: 7](../plume/src/proxy/RaffleProxy.sol#L7)

	```solidity
	contract RaffleProxy is ERC1967Proxy {
	```

- Found in src/proxy/SPINProxy.sol [Line: 11](../plume/src/proxy/SPINProxy.sol#L11)

	```solidity
	contract SpinProxy is ERC1967Proxy {
	```

- Found in src/spin/Raffle.sol [Line: 17](../plume/src/spin/Raffle.sol#L17)

	```solidity
	contract Raffle is Initializable, AccessControlUpgradeable, UUPSUpgradeable {
	```

</details>



## H-8: Reentrancy: State change after external call

Changing state after an external call can lead to re-entrancy attacks.Use the checks-effects-interactions pattern to avoid this issue.

<details><summary>4 Found Instances</summary>


- Found in src/spin/Raffle.sol [Line: 193](../plume/src/spin/Raffle.sol#L193)

	State is changed at: `prizeRanges[prizeId].push(
            Range({ user: msg.sender, cumulativeEnd: newTotal })
        )`, `totalTickets[prizeId] = newTotal`, `userHasEnteredPrize[prizeId][msg.sender] = true`, `totalUniqueUsers[prizeId]++`
	```solidity
	        (,,,, uint256 userRaffleTickets,,) = spinContract.getUserData(msg.sender);
	```

- Found in src/spin/Raffle.sol [Line: 195](../plume/src/spin/Raffle.sol#L195)

	State is changed at: `prizeRanges[prizeId].push(
            Range({ user: msg.sender, cumulativeEnd: newTotal })
        )`, `totalTickets[prizeId] = newTotal`, `userHasEnteredPrize[prizeId][msg.sender] = true`, `totalUniqueUsers[prizeId]++`
	```solidity
	        spinContract.spendRaffleTickets(msg.sender, ticketAmount);
	```

- Found in src/spin/Raffle.sol [Line: 225](../plume/src/spin/Raffle.sol#L225)

	State is changed at: `pendingVRFRequests[requestId] = prizeId`
	```solidity
	        uint256 requestId = supraRouter.generateRequest(
	```

- Found in src/spin/Spin.sol [Line: 190](../plume/src/spin/Spin.sol#L190)

	State is changed at: `userNonce[nonce] = payable(msg.sender)`, `pendingNonce[msg.sender] = nonce`
	```solidity
	        uint256 nonce = supraRouter.generateRequest(callbackSignature, rngCount, numConfirmations, clientSeed, admin);
	```

</details>
